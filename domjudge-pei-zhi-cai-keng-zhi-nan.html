<!DOCTYPE html>
<html lang="zh-cn">
<head>
          <title>Coherence - DOMjudge 配置/踩坑指南</title>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />





</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Coherence</a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li class="active"><a href="/category/misc.html">misc</a></li>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="/domjudge-pei-zhi-cai-keng-zhi-nan.html" rel="bookmark"
         title="Permalink to DOMjudge 配置/踩坑指南">DOMjudge 配置/踩坑指南</a></h2>
 
  </header>
  <footer class="post-info">
    <time class="published" datetime="2018-12-19T20:12:51+08:00">
      Wed 19 December 2018
    </time>
    <div class="category">
        Category: <a href="/category/misc.html">misc</a>
    </div>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <h2>- ACM</h2>
<p>我校新生赛也能用上 World Final 同款评测系统啦~</p>
<p>DOMjudge 提供了详尽的<a href="https://www.domjudge.org/documentation">官方文档</a>，然而对于博主这种英文弱鸡来说读的很痛苦。前前后后折腾了有两个星期吧，以此文作为避（踩）坑指南。</p>
<!-- more -->

<h2>简介</h2>
<p>DOMjudge，作为一款开源的 CCS(<a href="https://clics.ecs.baylor.edu/index.php?title=Contest_Control_System">Contest Control System</a>)，现已被ICPC钦定为官方的比赛评测系统。比 pc^2 这种闭源而含有诸多 Bug 的 CCS 高到不知道哪里去了啊。</p>
<p><img alt="1545218741334" src="Domjudge-config/1545218741334.png"></p>
<p>根据官方文档的描述，DOMjudge 的主要特性有：</p>
<ul>
<li>分布式且自动评测的 judge host</li>
<li>Web 用户界面</li>
<li>模块化的系统，方面添加不同的语言/编译器</li>
</ul>
<p>整个 DOMjudge 主要分为两个部分，Domserver 和 Judgehost，据其名字即可得出它们的功能。需要注意的是，DOMjudge 使用数据库来存放几乎一切数据，所以我们还需配置 MySQL 或者 MariaDB。</p>
<h2>安装</h2>
<p>DOMjudge 只能运行在 Linux 环境下。博主的运行环境是 Ubuntu Server 18.04 LTS，以及 DOMjudge 7.1.1。</p>
<p>除了传统的安装方式外，DOMjudge 还提供了 Docker 镜像以供安装，这样就大大简化了安装的困难程度。</p>
<p>关于 Docker 的使用这里不作详细描述。（其实是博主也一知半解）</p>
<p>然而<a href="https://hub.docker.com/r/domjudge/domserver">官方的 Docker 文档中</a>仅使用了命令来启动容器，为了进一步简化安装，也为了方便修改配置，我决定采用 Docker Compose 。以下是 <code>docker-compose.yml</code>文件：</p>
<div class="highlight"><pre><span></span><code><span class="nt">version</span><span class="p">:</span> <span class="s">&quot;3&quot;</span>
<span class="nt">services</span><span class="p">:</span>
  <span class="nt">mariadb</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mariadb</span>
    <span class="nt">container_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">dj-mariadb</span>
    <span class="nt">environment</span><span class="p">:</span> 
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">MYSQL_ROOT_PASSWORD=rootpw</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">MYSQL_USER=domjudge</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">MYSQL_PASSWORD=djpw</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">MYSQL_DATABASE=domjudge</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">$PWD/data:/var/lib/mysql</span>
    <span class="nt">ports</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">13306:3306</span>
    <span class="nt">command</span><span class="p">:</span> 
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--max-connections=1000</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--innodb-log-file-size=480M</span>
  <span class="nt">domserver</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">domjudge/domserver:latest</span>
    <span class="nt">container_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">domserver</span>
    <span class="nt">environment</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">MYSQL_HOST=mariadb</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">MYSQL_USER=domjudge</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">MYSQL_DATABASE=domjudge</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">MYSQL_PASSWORD=djpw</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">MYSQL_ROOT_PASSWORD=rootpw</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">CONTAINER_TIMEZONE=Asia/Shanghai</span>
    <span class="nt">restart</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">always</span>
    <span class="nt">depends_on</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">phpmyadmin</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">mariadb</span>
    <span class="nt">ports</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">80:80</span>
    <span class="nt">links</span><span class="p">:</span> 
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">mariadb</span>
  <span class="nt">judgehost</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">domjudge/judgehost:latest</span>
    <span class="nt">container_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">judgedaemon-0</span>
    <span class="nt">privileged</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="nt">environment</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">CONTAINER_TIMEZONE=Asia/Shanghai</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">DAEMON_ID=0</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">JUDGEDAEMON_PASSWORD=whatthehell</span>
    <span class="nt">depends_on</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">domserver</span>
    <span class="nt">links</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">domserver</span>
    <span class="nt">restart</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">always</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/sys/fs/cgroup:/sys/fs/cgroup:ro</span>
  <span class="nt">phpmyadmin</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">phpmyadmin/phpmyadmin</span>
    <span class="nt">container_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">myadmin</span>
    <span class="nt">ports</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8080:80</span>
    <span class="nt">environment</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">PMA_HOST=mariadb</span>
    <span class="nt">links</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">mariadb:mariadb</span>
</code></pre></div>

<p>然后运行 <code>docker-compose up -d</code> 即可完成部署。</p>
<p>Judgehost 利用了 Linux 内核的 Cgroup 特性，所以需进行一步额外设置（似乎部分内核较新的系统不需要）。编辑 <code>/etc/default/grub</code> 文件，将默认的命令改为：</p>
<div class="highlight"><pre><span></span><code><span class="nv">GRUB_CMDLINE_LINUX_DEFAULT</span><span class="o">=</span><span class="s2">&quot;quiet cgroup_enable=memory swapaccount=1&quot;</span>
<span class="nv">GRUB_CMDLINE_LINUX</span><span class="o">=</span><span class="s2">&quot;quiet cgroup_enable=memory swapaccount=1&quot;</span>
</code></pre></div>

<p>然后运行 <code>update-grub</code> 并重启。</p>
<p>需要多核判题的话创建多个 Judgehost 容器并修改 DAEMON_ID 为不同的值即可。</p>
<p>目前存在的问题：</p>
<ul>
<li>judgehost 用户的初始密码不定，需要手动去 web 端更改并添加 <code>JUDGEDAEMON_PASSWORD</code> 的环境变量。（默认环境变量的密码是 <code>password</code>）</li>
<li>整个系统对我来说是个黑盒...</li>
</ul>
<p>除了 MariaDB , DOMserver , Judgehost 这三个必要的容器外，我还使用了 phpMyAdmin 来进行图形化的数据库管理（备份)。数据库（即 <code>mariadb</code> 容器的数据卷）创建在了当前目录的<code>data</code>文件夹下，方便备份。</p>
<p>其中，Domserver 映射到了主机的 80 端口， phpMyAdmin 映射到了 8080 端口。由于是内网环境，故不准备采用 HTTPS 加密。</p>
<p>需要注意的是，DOMjudge 提供的 Judgehost 镜像中仅包含 C, C++, Java 三种语言的运行环境。</p>
<h2>配置</h2>
<p>Domserver 部署成功后，即可通过 Web 端来访问了。默认的管理员账号用户名 <code>admin</code> ，默认密码被打印在domserver启动时的日志中，同时也可以用<code>docker exec -it domserver cat /opt/domjudge/domserver/etc/initial_admin_password.secret</code>来获取 。</p>
<p>可以在 Config Checker 中进行配置检查。</p>
<p>C++ 的默认编译选项没有 C++11， 需手动添加。</p>
<h3>题目导入</h3>
<p>DOMjudge 支持用 zip 格式的压缩包导入/导出题目。</p>
<p>具体的文件结构是：</p>
<div class="highlight"><pre><span></span><code><span class="err">│  domjudge-problem.ini</span>
<span class="err">│</span>
<span class="err">├─data</span>
<span class="err">│  ├─sample</span>
<span class="err">│  └─secret</span>
<span class="err">│</span>
<span class="err">└─problem_statement</span>
<span class="err">        problem.{pdf,html,txt}</span>
</code></pre></div>

<p>在 <code>domjudge-problem.ini</code> 中定义了如下信息：</p>
<p><img alt="1545219324330" src="Domjudge-config/1545219324330.png"></p>
<p>（懒得翻译了，有时间再补）</p>
<p>在 secret 文件夹中存放测试数据，在 sample 文件夹中存放样例数据， 在 problem_statement 存放题面。</p>
<p>（不知道为什么博主在压缩包内上传题面没有成功过，只能通过 Web 端来上传）</p>
<p>测试数据的扩展名为 <code>.in</code> 和 <code>.ans</code>。</p>
<h3>队伍导入</h3>
<p>队伍及用户导入采用 tsv(<em>tab-separated values</em>) 格式，即信息之间采用制表符（TAB）分隔。事实上，文件的扩展名并不需要采用<code>.tsv</code>。我们可以直接在Excel中创建一个表格然后将其后复制至一个文本文件中。</p>
<p>格式由<a href="https://clics.ecs.baylor.edu/index.php?title=Contest_Control_System_Requirements#Appendix:_File_formats"> ICPC 官方定义</a>。</p>
<p>teams 格式：</p>
<div class="highlight"><pre><span></span><code><span class="err">teams    1</span>
<span class="err">team_id    external_ID    group_id    team_name    institution_name institution_short_name    country_code</span>
</code></pre></div>

<p>参考<a href="https://cubercsl.cn/notes/DOMjudge-Note.html">CSL的博客</a>发现：</p>
<blockquote>
<p>在导入teams表的时候，在<code>Country Code</code>后追加一列，填写<code>Institution External ID</code>。
这步是阅读<a href="https://github.com/DOMjudge/domjudge/blob/master/lib/lib.impexp.php#L108">源代码</a>后猜测的，当时的实际操作是直接在数据库中的<code>team_affiliation</code>用SQL语句更新<code>ExternalID</code>的。</p>
</blockquote>
<p>博主采用了这种方式，并在导入队伍后通过 Web 界面手动添加 Affiliation 信息。</p>
<p>事实上，institution_name  institution_short_name    country_code这三个字段都不是必要的，只需要有External ID就可以。而如果没有External ID的话，会创建和队伍数量一样多的Affiliation。</p>
<p>accounts 格式：</p>
<div class="highlight"><pre><span></span><code><span class="err">accounts  1</span>
<span class="err">account_type  fullname  username  password</span>
</code></pre></div>

<p>一种（可能）简单的方式是先导入队伍再导入用户，并且用户 username 的后缀数字与 team_id 相同。不需要的字段可以直接留空。（不能缺少分隔符）</p>
<p>tsv 文件可以采用 Excel 生成。在 Excel 中输入完数据后选择另存为文本文件（制表符分隔）即可。</p>
<p>如需使用<code>institution_name institution_short_name country_code</code> 三项需在 Team Affiliations 中提前创建相应的条目。</p>
<h3>API</h3>
<p>参考官方的 API 说明，DOMjudge 包含<a href="https://clics.ecs.baylor.edu/index.php/Contest_API"> ICPC 定义的 API </a>和<a href="https://www.domjudge.org/demoweb/api/doc">自有的 API</a>。</p>
<p><img alt="1545220336183" src="Domjudge-config/1545220336183.png"></p>
<h3>滚榜</h3>
<p>尝试使用官方的 <a href="https://icpc.baylor.edu/icpctools/">ICPC tools</a>，发现总是提示比赛未结束，查阅日志认为是 DOMjudge 的 event feed 格式与 ICPC tools 提供的 resolver 工具的格式不兼容。</p>
<p>尝试 DOMjura 发现同样不能正确读取 event-feed 。</p>
<hr>
<p>2019年校赛补充：滚榜采用了 Github 上的<a href="https://github.com/hex539/scoreboard">这个项目</a>。这比官方的滚榜工具好用多了，但是也有坑。</p>
<p>首先它使用bazel作为构建工具，但是bazel对于Windows很不友好（至少对于这个项目而言），会有奇怪的报错。所以我使用了Ubuntu。其次，由于构建过程中大部分源都在国外，对于国内的网络环境来说很不友好。我的解决办法是使用proxychains代理bazel，实测无需任何配置即可支持Domjudge 7.1.1（2019/12/7）。</p>
<h2>2018冬季新生赛概况</h2>
<p>闲扯几句。</p>
<p>热身赛一切良好。出题人数据出锅，被批判了一个多小时2333。</p>
<p>正式赛赛前比赛账号导入的时候，有个人是后来添加的，和之前的版本没有对应上，导致部分队伍登录到了后一个队伍的账号，重新导入 team 后发现无法登录，还需导入 accounts。这导致比赛推迟了 5 分钟。</p>
<p>由于 Submission 的输出数据是保留的，而赛前我的服务器硬盘空间本来就不多了，比赛时当服务器的硬盘占用达到 90% 时，所有 judgehost 就都被关了。我只能胡乱删几个软件包腾出空间。还好没有造成大的影响。</p>
<p>然后直到最后还是没有搞出滚榜。</p>
<p>GG。总体来说还是挺顺利的，服务器没有崩，甚至平均 CPU load 只有 1.0 左右，就是感觉比较吃 I/O，还好我用的是固态（~~先见之明~~）。</p>
<p>总结一下，DOMjudge 体验极佳，可以在校赛再推广一波。</p>
<h2>2019冬季新生赛概况</h2>
<p>由于今年懒得去嫖学校的服务器了，所以打算用公网服务器。本来在GCP和阿里云之间纠结用哪个，给我恰好滑稽给我提供了他在镇江的独服，于是建了一个16C，16G内存的虚拟机用作评测服务器（顺带送了个域名）。</p>
<p>这台服务器的网络结构比较复杂，首先，他是Windows Server，通过一个软件把某些端口的流量转发至一台Debian虚拟机中（为了方便管理证书等），然后由Debian上的Nginx反代至Domjudge的虚拟机中。这样我自己就不用配置证书也能有HTTPS。</p>
<p>但是Windows有一个老生常谈的坑：时间问题。Windows的硬件时钟是本地时间，而Linux为UTC时间，这导致了一开始Domjudge里的时间是假的，需要手动设置。</p>
<p>本次Domjudge的配置基本与之前相同，用Docker-compose一键部署。</p>
<p>之前一直没有做过压力测试一直是我的遗憾，这次在研究了Domjudge的<a href="https://www.domjudge.org/demoweb/api/doc">API文档</a>之后，写了一个<a href="Domjudge-config/submit.py">自动交题的脚本</a>，并且用Locust辅助做压力测试，然后评测机不负众望炸了。。</p>
<p><img alt="image-20191208184458561" src="Domjudge-config/image-20191208184458561.png"></p>
<p>其实还不止这个错，还有各种奇怪的错误。幸好在正式比赛中评测机表现得很稳健，并没有出锅，应该是压力还不够大。。</p>
<p>比赛时还碰到一个bug，在一道题重测后这道题的一血变更了，但是榜单上的一血是错的，重新刷新榜单也未解决。查看数据库表发现有一张叫<code>scorecache</code>的表，推测该表即为榜单的缓存，于是更改<code>is_first_solved</code>字段后，成功解决。</p>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>