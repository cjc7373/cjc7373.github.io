<!DOCTYPE html>
<html lang="zh-cn">
<head>
          <title>Coherence - WSL使用体验</title>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />





</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Coherence</a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li class="active"><a href="/category/misc.html">misc</a></li>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="/wslshi-yong-ti-yan.html" rel="bookmark"
         title="Permalink to WSL使用体验">WSL使用体验</a></h2>
 
  </header>
  <footer class="post-info">
    <time class="published" datetime="2019-12-08T19:12:51+08:00">
      Sun 08 December 2019
    </time>
    <div class="category">
        Category: <a href="/category/misc.html">misc</a>
    </div>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <p>首先，WSL真香！</p>
<!-- more -->

<h2>开启WSL</h2>
<p>最简单的方式是使用管理员权限运行Powershell，然后输入：</p>
<p><code>Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Windows-Subsystem-Linux</code></p>
<p>重启电脑，然后在应用商店中安装WSL发行版。</p>
<h2>Arch</h2>
<p>注意到WSL是没有Arch Linux发行版的（以前有一个非官方的，很快被下架了），但是我们有办法添加Arch发行版。去<a href="https://github.com/yuk7/ArchWSL">这个仓库</a>下载打包好的appx文件和证书，首先将证书导入至受信任的根证书颁发机构，然后安装appx即可。</p>
<h2>体验</h2>
<h3>坑</h3>
<ul>
<li>
<p>默认WSL不会读取<code>~/.bashrc</code>而会读取<code>~/.bash_profile</code>，所以需要在<code>~/.bash_profile</code>中写入：</p>
<p><code>bash
if [[ -f ~/.bashrc ]] ; then
  . ~/.bashrc
fi</code></p>
<p>才能够正常读取bash配置。</p>
</li>
</ul>
<h3>Netcat</h3>
<p>首先我Google到的是<code>gnu-netcat</code>。但是运行时报错<code>nc: core.c:372: core_tcp_connect: Assertion ret == 0' failed.</code>搜索了<a href="https://github.com/msys2/MSYS2-packages/issues/1030">相关Issus</a>之后，我更换成了<a href="https://www.archlinux.org/packages/community/x86_64/openbsd-netcat/">openbsd-netcat</a>，问题解决。</p>
<h3>缺点</h3>
<ul>
<li>WSL下无法使用Docker等涉及内核的操作，该缺陷在WSL2中被解决。</li>
<li>默认无图形界面，使用GUI需自己安装X Server，较为麻烦。</li>
</ul>
<h2>Windows Terminal</h2>
<p>注意，截至目前，Windows Terminal仍处于预览阶段，正式发布预计要到2020年4月。</p>
<p><img alt="image-20191115231943950" src="WSL使用体验/image-20191115231943950.png"></p>
<p>安装WSL后，Windows Terminal能够自动识别WSL并添加至可用Terminal列表中。</p>
<h3>Bug</h3>
<ul>
<li>启动Shell后的工作目录为Windows当前用户的Home目录，而非Linux的用户Home目录。</li>
</ul>
<p><img alt="image-20191115232130240" src="WSL使用体验/image-20191115232130240.png"></p>
<p>​ 可以通过在配置文件中加入<code>"commandline" : "wsl ~"</code>来解决，不过这个方案只适用于默认WSL发行版，对于其他发行版无效，可以通过在<code>.bashrc</code>中添加一条判断语句来解决。</p>
<ul>
<li>
<p>Windows Terminal目前暂无法自动添加至右键菜单上下文，需手动添加注册表。</p>
</li>
<li>
<p>往Terminal中粘贴内容是会自动在行间加空格。（更新：这个bug是由于\r\n与\n的处理问题，在0.7中被解决）</p>
<p><img alt="image-20191115233340872" src="WSL使用体验/image-20191115233340872.png"></p>
</li>
</ul>
<h2>WSL2</h2>
<h3>Docker</h3>
<p>可喜可贺，WSL终于能用Docker了。</p>
<p>配置镜像源（无systemd）：</p>
<blockquote>
<p>在配置文件 <code>/etc/default/docker</code> 中的 <code>DOCKER_OPTS</code> 中配置Hub地址：</p>
<p><code>DOCKER_OPTS="--registry-mirror=https://docker.mirrors.ustc.edu.cn/"</code></p>
<p>重新启动服务:</p>
<p><code>sudo service docker restart</code></p>
</blockquote>
<h3>坑</h3>
<ul>
<li>
<p>官方宣称在18945之后的版本中Windows访问WSL提供的网络服务只需使用localhost即可（服务需绑定之0.0.0.0而不是127.0.0.1，因为实际上这些连接被认为是局域网中的连接）。</p>
<p>尝试在Docker中使用。</p>
<p><img alt="image-20191116233838273" src="WSL使用体验/image-20191116233838273.png"></p>
<p>使用<code>netstat -ano</code>如下：</p>
<p><img alt="image-20191116233912110" src="WSL使用体验/image-20191116233912110.png"></p>
<p>然而在Windows下只能使用IPv6地址访问：</p>
<p><img alt="image-20191116233953189" src="WSL使用体验/image-20191116233953189.png">b</p>
<p>而不能使用IPv4：</p>
<p><img alt="image-20191116234023402" src="WSL使用体验/image-20191116234023402.png"></p>
</li>
<li>
<p>无法使用systemd。</p>
</li>
</ul>
<h2>Pycharm</h2>
<p>Pycharm能够将Python解释器设置为WSL中的Python。</p>
<p><img alt="image-20191119150317595" src="WSL使用体验/image-20191119150317595.png"></p>
<p>同时能够将terminal设置为WSL：</p>
<p><img alt="image-20191119150135830" src="WSL使用体验/image-20191119150135830.png"></p>
<p>只需要将Shell path设置成<code>bash.exe</code>即可。注意设置为<code>arch.exe</code>等自定义的发行版名称时，无法将当前工作目录传递给Shell。</p>
<p>注意到由于WSL没有图形界面，无法在Python中运行GUI程序。</p>
<h3>Bug</h3>
<p>~~在WSL中安装的包无法被识别：~~</p>
<p><img alt="image-20191119150405724" src="WSL使用体验/image-20191119150405724.png"></p>
<p>~~因此也无法使用这个包的自动补全、查看定义等一系列功能。~~</p>
<p><a href="https://www.jetbrains.com/help/pycharm/using-wsl-as-a-remote-interpreter.html">文档里</a>写得清清楚楚：</p>
<p><img alt="image-20191208194351006" src="WSL使用体验/image-20191208194351006.png"></p>
<p>我错了，我应该看文档的。安装rsync之后问题解决。</p>
<h2>参考资料</h2>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>