<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Linux Desktop on Coherence's Blog</title><link>https://blog.coherence.codes/tags/linux-desktop/</link><description>Recent content in Linux Desktop on Coherence's Blog</description><generator>Hugo</generator><language>zh-cn</language><copyright>Coherence. 本站遵循 CC BY-NC-SA 4.0 协议</copyright><lastBuildDate>Mon, 24 Mar 2025 00:00:00 +0000</lastBuildDate><atom:link href="https://blog.coherence.codes/tags/linux-desktop/index.xml" rel="self" type="application/rss+xml"/><item><title>记一次 mpv 异常关闭的调试</title><link>https://blog.coherence.codes/posts/2023/mpv_debug/</link><pubDate>Sun, 10 Dec 2023 00:00:00 +0000</pubDate><guid>https://blog.coherence.codes/posts/2023/mpv_debug/</guid><description>&lt;p>（EDIT 2025-03-24：这个 Bug 发生的环境是一加 8T+Oxygen OS，在我更换至 LineageOS 之后这个问题没有再出现过了。所以大概率是一加的锅..）&lt;/p>
&lt;h2 id="查不出的问题">查不出的问题&lt;/h2>
&lt;p>长久以来我都被 mpv 的一个问题所困扰，那就是在正常播放视频时 mpv 有概率会自动退出（通常是按下暂停键的时候）。通过 &lt;code>-v -v -v&lt;/code> 参数查看详细日志发现 mpv 接收到了 stop 命令：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">[&lt;/span>cplayer&lt;span style="color:#f92672">]&lt;/span> Run command: stop, flags&lt;span style="color:#f92672">=&lt;/span>64, args&lt;span style="color:#f92672">=[&lt;/span>flags&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>但是这个命令是谁发的不得而知。一开始怀疑是插件的问题，然而禁用所有插件（&lt;code>~/.config/mpv/scripts&lt;/code> 目录）后问题依旧。后尝试用 &lt;code>--no-config&lt;/code> 参数禁用所有配置，发现问题消失，于是尝试注释掉所有 &lt;code>mpv.conf&lt;/code> 中的配置，发现问题依旧。我还怀疑过是 &lt;code>pipewire&lt;/code>/&lt;code>xorg&lt;/code> 的问题，但是并没有搜索到相关信息。&lt;/p>
&lt;p>我还观察到 vlc 是不是也会出现播放时自动停止的现象，另外 youtube/bilibili 播放视频时会经常自动跳转到开头。后来证实这其实都是同一个问题导致的..&lt;/p>
&lt;h2 id="线索">线索&lt;/h2>
&lt;p>在 mpv 的 issue 中找到了一个问题相同的 &lt;a href="https://github.com/mpv-player/mpv/issues/11988">bug report&lt;/a>，开发者认为这是插件导致的，但是我已经禁用所有插件了，于是我留言询问应该如何排查，有一个人指出了可能和 &lt;code>mpv-mpris&lt;/code> 有关。&lt;/p>
&lt;p>&lt;a href="https://wiki.archlinux.org/title/MPRIS">MPRIS&lt;/a> 是一个 dbus 接口，提供了控制媒体播放器的相应 API，绝大多数应用，包括上述提到的几个，都支持这一接口。mpv 的 mpris 支持通过 &lt;code>mpv-mpris&lt;/code> 包提供。看到这个名字我恍然大悟，&lt;code>mpv-mpris&lt;/code> 由系统包管理器安装，因此并没有出现在用户的插件目录下。当即我查看了 &lt;code>mpv-mpris&lt;/code> 的源码，发现其为 mpv C 拓展，而不是常见的 Lua 拓展。&lt;/p>
&lt;p>从&lt;a href="https://github.com/hoyon/mpv-mpris/blob/16fee38988bb0f4a0865b6e8c3b332df2d6d8f14/mpris.c#L602C26-L602C26">这里&lt;/a>可以看到，它在收到 mpris 的 &lt;code>Stop()&lt;/code> 方法后，会向 mpv 发送 stop 命令，因此我准备加一行日志看看到底是不是 &lt;code>mpv-mpris&lt;/code> 导致了上述问题。询问了 ChatGPT 之后发现其对于如何在 mpv C 扩展中打印日志完全是在瞎扯.. 后来发现直接用 &lt;code>printf&lt;/code> 就行.. 从函数签名可以看到其包含了 sender 的信息，于是将其打印。这里我并没有 clone 仓库进行构建，而是直接复制 archlinux 中的 PKGBUILD，先用 &lt;code>makepkg -o&lt;/code> 下载解压源码，修改后再用 &lt;code>makepkg -e&lt;/code> 进行构建，这样做的好处是无需关心具体的构建流程以及如何应用构建后的插件，build 完直接装就行。&lt;/p></description></item><item><title>神秘的自动关闭显示器失效问题</title><link>https://blog.coherence.codes/posts/2023/%E7%A5%9E%E7%A7%98%E7%9A%84%E8%87%AA%E5%8A%A8%E5%85%B3%E9%97%AD%E6%98%BE%E7%A4%BA%E5%99%A8%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98/</link><pubDate>Mon, 04 Sep 2023 00:00:00 +0000</pubDate><guid>https://blog.coherence.codes/posts/2023/%E7%A5%9E%E7%A7%98%E7%9A%84%E8%87%AA%E5%8A%A8%E5%85%B3%E9%97%AD%E6%98%BE%E7%A4%BA%E5%99%A8%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98/</guid><description>&lt;h2 id="问题">问题&lt;/h2>
&lt;p>我的桌面环境为 KDE/X11，我在 KDE 的 Power Management 设置中设置了 &lt;code>Screen Energy Saving: Switch off after 5 min&lt;/code>，这个选项时不时地出问题，表现为刚开机时能够正常工作，在闲置五分钟后关闭显示器，但在一段时间过后就不行了，这个一段时间可长可短。重启电脑又能重新工作，而锁屏后也能够正常工作。这个问题从我用 KDE 开始就一直困扰着我，时至今日。&lt;/p>
&lt;h2 id="排查">排查&lt;/h2>
&lt;p>KDE 的电源管理由 powerdevil 控制，其作为 &lt;code>plasma-powerdevil.service&lt;/code> 用户服务运行，查询日志发现有一些神秘的 &lt;code>org_kde_powerdevil[1310]: QObject::disconnect: Unexpected nullptr parameter&lt;/code> 报错，之后证实该报错与本问题无关。&lt;/p>
&lt;p>查看该 &lt;code>.service&lt;/code> 文件发现其使用 &lt;code>Type=dbus&lt;/code> 的启动类型，并且获得了一个叫 &lt;code>org.kde.Solid.PowerManagement&lt;/code> 的 bus name。用 QBBusViewer 可以看到 powerdevil 还提供了 &lt;code>org.freedesktop.PowerManagement&lt;/code> 这一服务。&lt;/p>
&lt;p>查阅 powerdevil 源码以 &lt;code>Switch off after&lt;/code> 为关键词进行搜索可发现相关逻辑位于 &lt;code>daemon/actions/bundled/dpms.cpp&lt;/code> 文件下，根据名字猜测 dpms 即 Display Power Management Signaling 的缩写。简单看了一下 dpms，这是一个古老的协议，在 1993 年发布，定义了四种模式，但 &lt;a href="https://wiki.archlinux.org/title/Display_Power_Management_Signaling">archwiki 上&lt;/a>指出：&lt;/p>
&lt;blockquote>
&lt;p>Note that DPMS was developed for CRT monitors, and on LCD displays, there is normally no difference between the standby, suspend and off modes.&lt;/p></description></item></channel></rss>