<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Linux Desktop on Coherence's Blog</title><link>https://blog.coherence.codes/tags/linux-desktop/</link><description>Recent content in Linux Desktop on Coherence's Blog</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><copyright>Coherence. 本站遵循 CC BY-NC-SA 4.0 协议</copyright><lastBuildDate>Sun, 10 Dec 2023 00:00:00 +0000</lastBuildDate><atom:link href="https://blog.coherence.codes/tags/linux-desktop/index.xml" rel="self" type="application/rss+xml"/><item><title>记一次 mpv 异常关闭的调试</title><link>https://blog.coherence.codes/posts/2023/mpv_debug/</link><pubDate>Sun, 10 Dec 2023 00:00:00 +0000</pubDate><guid>https://blog.coherence.codes/posts/2023/mpv_debug/</guid><description>查不出的问题 长久以来我都被 mpv 的一个问题所困扰，那就是在正常播放视频时 mpv 有概率会自动退出（通常是按下暂停键的时候）。通过 -v -v -v 参数查看详细日志发现 mpv 接收到了 stop 命令：
[cplayer] Run command: stop, flags=64, args=[flags=&amp;#34;&amp;#34;] 但是这个命令是谁发的不得而知。一开始怀疑是插件的问题，然而禁用所有插件（~/.config/mpv/scripts 目录）后问题依旧。后尝试用 --no-config 参数禁用所有配置，发现问题消失，于是尝试注释掉所有 mpv.conf 中的配置，发现问题依旧。我还怀疑过是 pipewire/xorg 的问题，但是并没有搜索到相关信息。
我还观察到 vlc 是不是也会出现播放时自动停止的现象，另外 youtube/bilibili 播放视频时会经常自动跳转到开头。后来证实这其实都是同一个问题导致的..
线索 在 mpv 的 issue 中找到了一个问题相同的 bug report，开发者认为这是插件导致的，但是我已经禁用所有插件了，于是我留言询问应该如何排查，有一个人指出了可能和 mpv-mpris 有关。
MPRIS 是一个 dbus 接口，提供了控制媒体播放器的相应 API，绝大多数应用，包括上述提到的几个，都支持这一接口。mpv 的 mpris 支持通过 mpv-mpris 包提供。看到这个名字我恍然大悟，mpv-mpris 由系统包管理器安装，因此并没有出现在用户的插件目录下。当即我查看了 mpv-mpris 的源码，发现其为 mpv C 拓展，而不是常见的 Lua 拓展。
从这里可以看到，它在收到 mpris 的 Stop() 方法后，会向 mpv 发送 stop 命令，因此我准备加一行日志看看到底是不是 mpv-mpris 导致了上述问题。询问了 ChatGPT 之后发现其对于如何在 mpv C 扩展中打印日志完全是在瞎扯.</description></item><item><title>神秘的自动关闭显示器失效问题</title><link>https://blog.coherence.codes/posts/2023/%E7%A5%9E%E7%A7%98%E7%9A%84%E8%87%AA%E5%8A%A8%E5%85%B3%E9%97%AD%E6%98%BE%E7%A4%BA%E5%99%A8%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98/</link><pubDate>Mon, 04 Sep 2023 00:00:00 +0000</pubDate><guid>https://blog.coherence.codes/posts/2023/%E7%A5%9E%E7%A7%98%E7%9A%84%E8%87%AA%E5%8A%A8%E5%85%B3%E9%97%AD%E6%98%BE%E7%A4%BA%E5%99%A8%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98/</guid><description>问题 我的桌面环境为 KDE/X11，我在 KDE 的 Power Management 设置中设置了 Screen Energy Saving: Switch off after 5 min，这个选项时不时地出问题，表现为刚开机时能够正常工作，在闲置五分钟后关闭显示器，但在一段时间过后就不行了，这个一段时间可长可短。重启电脑又能重新工作，而锁屏后也能够正常工作。这个问题从我用 KDE 开始就一直困扰着我，时至今日。
排查 KDE 的电源管理由 powerdevil 控制，其作为 plasma-powerdevil.service 用户服务运行，查询日志发现有一些神秘的 org_kde_powerdevil[1310]: QObject::disconnect: Unexpected nullptr parameter 报错，之后证实该报错与本问题无关。
查看该 .service 文件发现其使用 Type=dbus 的启动类型，并且获得了一个叫 org.kde.Solid.PowerManagement 的 bus name。用 QBBusViewer 可以看到 powerdevil 还提供了 org.freedesktop.PowerManagement 这一服务。
查阅 powerdevil 源码以 Switch off after 为关键词进行搜索可发现相关逻辑位于 daemon/actions/bundled/dpms.cpp 文件下，根据名字猜测 dpms 即 Display Power Management Signaling 的缩写。简单看了一下 dpms，这是一个古老的协议，在 1993 年发布，定义了四种模式，但 archwiki 上指出：
Note that DPMS was developed for CRT monitors, and on LCD displays, there is normally no difference between the standby, suspend and off modes.</description></item></channel></rss>