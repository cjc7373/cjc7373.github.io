<!doctype html><html lang=zh><head><meta name=generator content="Hugo 0.149.0"><title>Coherence's Blog</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=5" name=viewport><meta content="telephone=no" name=format-detection><meta name=description content><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><link rel=stylesheet href=/scss/dark-mode.min.fa793cdb4ae2d683f9cccdaf1c7922313b4cf124910b552cbc6b3a7ae3b45926.css integrity="sha256-+nk820ri1oP5zM2vHHkiMTtM8SSRC1UsvGs6euO0WSY=" media=screen><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Material+Icons"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css integrity=sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js integrity=sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})})</script></head><body><div id=app><div class=single-column-drawer-container id=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item false" href=/posts>存档
</a><a class="a-block drawer-menu-item false" href=/tags>标签
</a><a class="a-block drawer-menu-item false" href=/categories>分类
</a><a class="a-block drawer-menu-item false" href=/friends>友链
</a><a class="a-block drawer-menu-item false" href=/about>关于
</a><a class="a-block drawer-menu-item false" href=/index.xml>RSS Feed</a></div></div></div><transition name=fade><div id=drawer-mask v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav id=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div id=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu
</i></button>
<a id=navTitle class=navbar-brand href=https://blog.coherence.codes/>Coherence's Blog
</a><button type=button class=nav-darkmode-toggle id=darkModeToggleButton2>
<i class=material-icons id=darkModeToggleIcon2>dark_mode</i></button></div></nav><div class=single-column-header-container id=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=https://blog.coherence.codes/><div class=single-column-header-title>Coherence's Blog</div></a></div><div id=content><div id=streamContainer class=stream-container><div class="post-list-container post-list-container-no-background"><a href=/posts/2025/my_nas_plan/ class=a-block><div class=post-item-wrapper><div class="post-item post-item-no-divider"><div class=post-item-info-wrapper><div class=post-item-title>我的 NAS 方案</div><div class=post-item-summary><p>很久之前，我就有组一个 NAS 的想法，直到今年才得以实现。</p><h2 id=选型>选型</h2><p>首先就是选择成品 NAS 还是 DIY。我并没有 NAS 的刚需，只是想在折腾中学习，所以自然是选择 DIY。基于战未来的考虑，直接选了个八盘位的机箱，而 CPU 方面目前看来没什么吃性能的应用，所以选了 n100。最终的配置如下：</p><ul><li>板U 云星 n100 550</li><li>m2 转 sata 拓展卡 75</li><li>机箱 乔思伯 n3 740</li><li>内存 拆机 8G 0</li><li>电源 Thermaltake 450W 钢影 SFX 420</li><li>系统盘 宏碁 128g 70</li></ul><p>合计 1850。这其中电源感觉严重冗余了，因为后面实测待机功率才 30w 左右。但是机箱只支持 SFX 电源，而低功率的 SFX 电源似乎比较少，350w 的 SFX 都挺垃圾的。说句题外话，在很久之前我的 nas 配置单上选的还是 i3-10100，那时候 12 代还没出..</p><p>软件同样有成品 NAS 系统和 DIY 可选，DIY 系统（比如装一个普通的 Linux 发行版）太费时费力了，所以还是选择成品的 NAS 系统。网上流行的 NAS 系统大概有：</p><ul><li>unraid，正如其名字所说的，没有 raid。整体是 JBOD（Just a Bunch of Disks）的思路，有单独的 parity disk。由于 data disk 的容量并不要求一致，所以 parity disk 要求大于等于最大的 data disk 容量。parity 用的也是奇偶校验。非开源，需付费购买授权，当然也有学习版。</li><li>黑群晖，优势是能使用群晖生态系统中的软件，但是由于是逆向出来的，难免有各种兼容性问题。使用 btrfs 作为文件系统，mdadm 管理阵列。</li><li>TrueNAS，基于 zfs，开源。开发商 ixsystems 本身也赞助了一些 zfs feature 的开发。卖企业版，也卖类似一体机的硬件。</li><li>飞牛，国产的 NAS 系统。非开源，免费使用。面向小白用户，基本能够开箱即用。似乎也是 btrfs+mdadm 的组合。后面应该会卖硬件。</li><li><del>（混沌邪恶）</del> Windows Server</li><li>OpenMediaVault，相对知名度没那么高的 NAS 系统，是从 FreeNAS（TrueNAS 的前身）fork 出来的。据维基百科介绍，这是因为 OMV 的开发者想要基于 Linux 来开发 FreeNAS。略显讽刺的是，truenas 在 2023 年宣布将全面转向 Linux，原先的 FreeBSD 版本（TrueNAS Core）将只会收到安全更新并被逐渐取代。</li></ul><p>在这之上，还可以先安装 PVE 作为虚拟化平台，然后在虚拟机里安装 NAS 系统。由于我很早的时候就看到过很多“鼓吹” zfs 的文章，所以文件系统的选型在一开始就定下了：zfs。并且我比较偏好开源系统，所以最终选择了 truenas。</p></div><div class=post-item-meta>2025-07-13
&emsp;
&emsp;</div></div></div></div><a href=/posts/2024/openwrt_transparent_proxy/ class=a-block><div class=post-item-wrapper><div class="post-item post-item-no-divider"><div class=post-item-info-wrapper><div class=post-item-title>OpenWrt 搭建透明代理</div><div class=post-item-summary><p>openclash、shellclash 之类的方案感觉都太复杂了。我的需求只是给 chromecast 用上代理，并且在代理失效时不要影响局域网中的其他设备。所以想找一个简单的方案。</p><p>经过一番摸索，发现 Macvlan 很适合我，具体步骤如下：</p><ul><li><p>创建一个 macvlan 设备</p><pre tabindex=0><code class=language-openwrt data-lang=openwrt>config device
        option type &#39;macvlan&#39;
        option ifname &#39;br-lan&#39;
        option mode &#39;bridge&#39;
        option name &#39;br-lanmac0&#39;
        option ipv6 &#39;1&#39;
</code></pre><p>注意这里需要选择启用 ipv6，否则 br-lan 不会下发 RA，导致局域网内设备没有 v6 地址，具体原因还不清楚。</p></li><li><p>创建一个接口绑定到这个设备</p><pre tabindex=0><code class=language-openwrt data-lang=openwrt>config interface &#39;clash&#39;
        option proto &#39;static&#39;
        option device &#39;br-lanmac0&#39;
        option ipaddr &#39;192.168.2.2&#39;
        option netmask &#39;255.255.255.0&#39;
        option gateway &#39;192.168.2.1&#39;
        option defaultroute &#39;0&#39;
</code></pre><p>IP 地址分配一个在局域网段下的，网关填 lan 地址。注意关闭默认路由，否则会把 PPPoE 的路由给删了，导致局域网内设备连不上网，具体原因也不清楚。这个接口不需要任何路由规则。</p></li><li><p>把这个接口添加到防火墙的 lan zone 中，否则 lan 发给该接口的包会被丢弃</p></li><li><p>下载 mihomo （原 clash-meta）二进制，配置 tun 绑定到之前的设备上</p></div><div class=post-item-meta>2024-11-24
&emsp;
&emsp;</div></div></div></div><a href=/posts/2024/linux_memory_management/ class=a-block><div class=post-item-wrapper><div class="post-item post-item-no-divider"><div class=post-item-info-wrapper><div class=post-item-title>Linux 内存管理初探</div><div class=post-item-summary><p>本文试图解释两个简单的问题：<code>free</code> 命令中的 used/free/available 等字段究竟代表了什么？而 <code>ps</code> 命令中的 VSZ/RSS 又代表了什么？</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ free -h
</span></span><span style=display:flex><span>               total        used        free      shared  buff/cache   available
</span></span><span style=display:flex><span>Mem:            38Gi        15Gi       834Mi       3.3Gi        25Gi        22Gi
</span></span><span style=display:flex><span>Swap:           19Gi       5.3Gi        14Gi
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ ps aux --sort<span style=color:#f92672>=</span>-rss | head -5
</span></span><span style=display:flex><span>USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
</span></span><span style=display:flex><span>cjc         <span style=color:#ae81ff>3354</span>  2.3  4.6 <span style=color:#ae81ff>97222056</span> <span style=color:#ae81ff>1917888</span> ?    Ssl  Oct07  37:42 /usr/bin/qbittorrent
</span></span><span style=display:flex><span>cjc       <span style=color:#ae81ff>354324</span>  1.3  2.7 <span style=color:#ae81ff>2772076</span> <span style=color:#ae81ff>1137784</span> ?     Ssl  12:05   1:59 /usr/bin/telegram-desktop
</span></span><span style=display:flex><span>cjc         <span style=color:#ae81ff>2806</span>  6.6  2.3 <span style=color:#ae81ff>4141220</span> <span style=color:#ae81ff>941484</span> ?      Sl   Oct07 109:17 /usr/bin/kwin_wayland ...
</span></span><span style=display:flex><span>cjc         <span style=color:#ae81ff>3390</span>  1.5  1.9 <span style=color:#ae81ff>3994932</span> <span style=color:#ae81ff>792364</span> ?      Sl   Oct07  26:10 /usr/lib/zotero/zotero-bin ...
</span></span></code></pre></div><p>本文假定读者具有虚拟内存的基础知识，文中的代码将以 C 语言为例。</p></div><div class=post-item-meta>2024-09-05
&emsp;
&emsp;</div></div></div></div><a href=/posts/2024/japan_trip/ class=a-block><div class=post-item-wrapper><div class="post-item post-item-no-divider"><div class=post-item-info-wrapper><div class=post-item-title>日本之旅</div><div class=post-item-summary><h2 id=计划>计划</h2><p>我和 Moo 一开始说的是去新马泰，后来改为日本，真正开始做攻略已经是三月下旬了。日本只支持旅行社送签，我在 3/26 申请了签证并提交了材料，4/3 出签，花了六个工作日，还是挺快的。</p><p><img src=./image-20240424004023270.png alt=image-20240424004023270></p><p>订机票和酒店的时候差不多离出发还有半个月，这时候的价格已经挺贵了，可能提前两三个月订会更便宜。初步的计划是东京->京都->大阪，详细的计划写在 hackmd 上。实际上我们的计划并不详细，只是提前订了 Tokyo Skytree、Shibuya sky 的票，规定了一下在东京的那几天每天在哪个区域活动，而在京都和大阪的行程则完全没有计划，全靠临时起意。</p><p>我在出发前半个月用多邻国速成了两周日语，非常失败，五十音都没认全，还是只能用英语交流。结论为不如用 Anki 认五十音。</p><h2 id=流水账>流水账</h2><h3 id=413>4/13</h3><p>终于踏上了去东京的旅程，虽然很怕在途中突然被要求改论文/交材料，but be it，放心玩，越玩越稳。</p><p>我是先到杭州东，坐<a href=https://zh.wikipedia.org/zh-cn/%E5%A4%8D%E5%85%B4%E5%8F%B7CR200J%E5%9E%8B%E5%8A%A8%E8%BD%A6%E7%BB%84>垃圾桶</a>去上海南，再坐地铁去浦东机场，这套流程也太长了，我上午十点出发，三点半才到浦东机场。</p><p><figure><img src=/posts/2024/japan_trip/image-20240424004456080.png width=500px></figure>（来点经典小红书照片）</p><p>Moo 买的是西安->上海浦东->东京成田的中转航班，第二段和我是同一个航班，本来的计划是浦东机场会合。然而不幸的是当天西安有雷雨天气，第一段航班延误了大概两个小时，导致赶不上第二段航班，只能改签。日本的手机卡是 Moo 买的，由于 Moo 延误了，一个问题就是我在日本的第一天没有网。下飞机了发现我的电信卡没有国际漫游。有的话用一天 25，其实可以接受，但是我的卡已经没信号收不了短信了，只能微信喊我爸问了下客服，说是要换卡才能开通？这是什么操作。于是只能去便利店高价（880 日元的卡费 + 1300 日元三天的套餐费）买了张卡。</p><p>出关的时候排队排了好久，大概有半个多小时，很多人可能是填的纸质材料比较慢，我填了 Visit Japan Web 感觉就半分钟就办完了。本来我们在线买的两张 Skyliner 票，只要凭兑换二维码兑换车票就行，然而现在就我一个人，和 staff 交流了半天，最后的办法是退我们网上买的票，然后重新分别买。本打算顺便买交通卡的，但是卖卡的地方（不知道有没有别的地方，我问到的应该是在 Skyliner & Keisai Information Center）十点关门了，于是没买到。</p><p>到达第一天的青旅的时候已经过十一点了，被加收了 1000 日元 late check-in fee。入住的时候我说这是我第一次来日本，前台小哥特地说了一句“Welcome to Japan”。住的是十四人间（！），但是大家都挺安静的，只是晚上和早上在 lobby 都没见着什么人，没有交流。青旅建在铁路正下方，列车驶过的声音还挺大的。不过这地段是相当好啊，就在天空树旁边。</p><p><img src=./image-20240424015124861.png alt=image-20240424015124861></p><p>（Wise Owl Hostels 就是我住的青旅，上面就是铁路）</p></div><div class=post-item-meta>2024-04-24
&emsp;
&emsp;</div></div></div></div><a href=/posts/2024/go_pkg_mgmt_1_toturial/ class=a-block><div class=post-item-wrapper><div class="post-item post-item-no-divider"><div class=post-item-info-wrapper><div class=post-item-title>Go 包管理（一）入门和设计原则</div><div class=post-item-summary><p>在我初学 Go 的时候，曾被网上的过时教程和各种对 <code>$GOPATH</code> 的操作搞得云里雾里，而现在我们已经基本用不到 <code>$GOPATH</code> 了，因为在 2023 年， Go Modules 已经一统天下了。但是在这之前，是群魔乱舞的时代，对这段历史感兴趣的同学可以参考<a href=https://blog.wolfogre.com/posts/golang-package-history/>这篇博客</a>。</p><p>顺便提一下，GOPATH 时代包没有“版本”的概念，这可能是因为 Google 内部采用 monorepo 的方式（即所有代码都放在一个仓库中）管理代码，所有人都基于 HEAD 来 build，所以当有人的改动 break 了其他人的代码时，很容易在 build 时反映出来。Go 作者之一 Rob Pike 的文章 <a href=https://commandcenter.blogspot.com/2024/01/what-we-got-right-what-we-got-wrong.html>What We Got Right, What We Got Wrong</a> 中提到了这一点。</p><p>Go 包管理的转折来源于 2018 年 2 月 Go 作者之一 Russ Cox 在其博客上连发数篇文章进行了 Go Modules 的设计：</p><p><img src=./image-20231227012240619.png alt=image-20231227012240619></p><p>并最终在 Go 1.11 (2018/8) 中发布。</p><p>按照 <a href=https://go.dev/wiki/GOPATH>GOPATH wiki</a> 所述，从 Go 1.16 (2021/2) 开始，<code>GO111MODULE=on</code> 变量被默认设置，除非显式修改该变量，否则 Go Modules 会默认启用。当使用 Go Modules 时，<code>GOPATH</code> 将不再用于解析导入路径。但它仍然被用于存储下载的包（<code>$GOPATH/pkg/mod</code>）和二进制命令（<code>$GOPATH/bin</code>）。比如 Go 的 language server <code>gopls</code> 通常会被安装到 <code>$GOPATH/bin</code> 下，所以这个目录通常会加入到 <code>$PATH</code> 中。</p></div><div class=post-item-meta>2024-01-06
&emsp;
&emsp;</div></div></div></div><a href=/posts/2023/mpv_debug/ class=a-block><div class=post-item-wrapper><div class="post-item post-item-no-divider"><div class=post-item-info-wrapper><div class=post-item-title>记一次 mpv 异常关闭的调试</div><div class=post-item-summary><p>（EDIT 2025-03-24：这个 Bug 发生的环境是一加 8T+Oxygen OS，在我更换至 LineageOS 之后这个问题没有再出现过了。所以大概率是一加的锅..）</p><h2 id=查不出的问题>查不出的问题</h2><p>长久以来我都被 mpv 的一个问题所困扰，那就是在正常播放视频时 mpv 有概率会自动退出（通常是按下暂停键的时候）。通过 <code>-v -v -v</code> 参数查看详细日志发现 mpv 接收到了 stop 命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>cplayer<span style=color:#f92672>]</span> Run command: stop, flags<span style=color:#f92672>=</span>64, args<span style=color:#f92672>=[</span>flags<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>但是这个命令是谁发的不得而知。一开始怀疑是插件的问题，然而禁用所有插件（<code>~/.config/mpv/scripts</code> 目录）后问题依旧。后尝试用 <code>--no-config</code> 参数禁用所有配置，发现问题消失，于是尝试注释掉所有 <code>mpv.conf</code> 中的配置，发现问题依旧。我还怀疑过是 <code>pipewire</code>/<code>xorg</code> 的问题，但是并没有搜索到相关信息。</p><p>我还观察到 vlc 是不是也会出现播放时自动停止的现象，另外 youtube/bilibili 播放视频时会经常自动跳转到开头。后来证实这其实都是同一个问题导致的..</p><h2 id=线索>线索</h2><p>在 mpv 的 issue 中找到了一个问题相同的 <a href=https://github.com/mpv-player/mpv/issues/11988>bug report</a>，开发者认为这是插件导致的，但是我已经禁用所有插件了，于是我留言询问应该如何排查，有一个人指出了可能和 <code>mpv-mpris</code> 有关。</p><p><a href=https://wiki.archlinux.org/title/MPRIS>MPRIS</a> 是一个 dbus 接口，提供了控制媒体播放器的相应 API，绝大多数应用，包括上述提到的几个，都支持这一接口。mpv 的 mpris 支持通过 <code>mpv-mpris</code> 包提供。看到这个名字我恍然大悟，<code>mpv-mpris</code> 由系统包管理器安装，因此并没有出现在用户的插件目录下。当即我查看了 <code>mpv-mpris</code> 的源码，发现其为 mpv C 拓展，而不是常见的 Lua 拓展。</p><p>从<a href=https://github.com/hoyon/mpv-mpris/blob/16fee38988bb0f4a0865b6e8c3b332df2d6d8f14/mpris.c#L602C26-L602C26>这里</a>可以看到，它在收到 mpris 的 <code>Stop()</code> 方法后，会向 mpv 发送 stop 命令，因此我准备加一行日志看看到底是不是 <code>mpv-mpris</code> 导致了上述问题。询问了 ChatGPT 之后发现其对于如何在 mpv C 扩展中打印日志完全是在瞎扯.. 后来发现直接用 <code>printf</code> 就行.. 从函数签名可以看到其包含了 sender 的信息，于是将其打印。这里我并没有 clone 仓库进行构建，而是直接复制 archlinux 中的 PKGBUILD，先用 <code>makepkg -o</code> 下载解压源码，修改后再用 <code>makepkg -e</code> 进行构建，这样做的好处是无需关心具体的构建流程以及如何应用构建后的插件，build 完直接装就行。</p></div><div class=post-item-meta>2023-12-10
&emsp;
&emsp;</div></div></div></div><a href=/posts/2023/mit_6.824_2_raft/ class=a-block><div class=post-item-wrapper><div class="post-item post-item-no-divider"><div class=post-item-info-wrapper><div class=post-item-title>MIT 6.824 学习笔记(二) Raft</div><div class=post-item-summary><p>本文主要是对 Raft 论文的翻译，为了保持准确性，我会尽量使用英文术语。</p><h2 id=introduction>Introduction</h2><p>在过去十年，Leslie Lamport 的 Paxos 协议几乎成为了共识的同义词。Paxos 首先定义了一种协议来对单个决定达成共识, 比如一条单个的 log entry, 这被称为 single-decree Paxos。 其支持多个决定的版本 (比如 log) 被称为 muti-Paxos。然而，Paxos 的缺点是难以理解，并且没有提供一个良好的基础来构建可行的实现。</p><blockquote><p>试图为这个主题增添一点幽默的尝试以惨淡的失败告终。……这个希腊寓言显然使阅读论文的人们分心了，以致于他们无法理解这个算法。我把论文发给了一些人，其中包括 Nancy Lynch, Vassos Hadzilacos 和 Phil Bernstein，他们声称读过了论文。几个月后我发邮件给他们问了如下问题：</p><pre><code>你能否实现一个分布式数据库，它能容忍任何进程的故障（可能是所有进程）而不牺牲一致性，并且在超过半数进程恢复之后继续正常工作？
</code></pre><p>没有人察觉到这个问题和 Paxos 算法之间有任何联系。</p><p>—— Leslie Lamport <a href="https://lamport.azurewebsites.net/pubs/pubs.html?from=https://research.microsoft.com/users/lamport/pubs/pubs.html&amp;type=path#lamport-paxos">对 The Part-Time Parliament 的评论</a></p></blockquote><p>相较于 Paxos，Raft 的目标是易于理解且符合直觉。为了使 Raft 易于理解，作者采取了解耦 (Raft 将共识问题分解成几个子问题 leader election, log replication, safety, and membership changes) 和缩减状态空间的方式。</p><p>Raft 和已有的共识算法类似（尤其是 Viewstamped Replication），但它有一些新特性。Raft 采取了强 leader 的设计，例如 log entry 只会从 leader 向其他节点分发。这可能是为了性能考虑（比无 leader 要更快，RPC 也更少）Raft 采用基于随机计时器的 leader 选举, 从而用一种简单的方法来解决冲突。另外还有处理成员变更方面的改进。</p></div><div class=post-item-meta>2023-10-01
&emsp;
&emsp;</div></div></div></div><a href=/posts/2023/git_%E5%85%A5%E9%97%A8/ class=a-block><div class=post-item-wrapper><div class="post-item post-item-no-divider"><div class=post-item-info-wrapper><div class=post-item-title>git 入门</div><div class=post-item-summary><p>本文的大部分内容来自于 <a href=https://git-scm.com/book/en/v2>Pro Git</a> 这本书。</p><h2 id=objects>Objects</h2><p>git 中最基础的元素是 object，每个 object 由一个 object ID (OID) 唯一标识，OID 是一个 160 bits （用 hex 字符串表示为四十个字符） 的 SHA-1 哈希。具体而言，git 中主要存在三种 objects：</p><ul><li><p><code>blobs</code>: 存储文件内容，OID 即为文件内容的哈希</p></li><li><p><code>trees</code>: 一个文件名（path entries）的有序列表，OID 为这个列表的哈希。列表的每一行如下：</p><pre tabindex=0><code>100644 blob 1fc4aa8f76027dd0fb8f9b533810770236d5c234    .gitignore
</code></pre><p>容易推测这几个字段分别为权限、object 类型、哈希、文件名。子目录同样是 trees。项目的根目录即为 root tree。所有的 trees 构成了一棵 Merkle tree，<del>所以 git 就是区块链（即答</del>。下图中三角代表 trees，方块为 blobs</p><p><img src=./image-20230918111328708.png alt=image-20230918111328708></p></li><li><p><code>commits</code>: 一个<strong>快照</strong>（snapshot），每个 commit 包含了一个到根 tree 的引用，和一个（或多个）到 parent 的引用。parent 就是上一个 commit 的 OID。在一个 merge commit 中会包含多个 parents。由于 Commit 存储的是快照而不是 diff，所以 Git checkout（切换分支）的速度很快。下图中圆形代表 commits</p></div><div class=post-item-meta>2023-09-18
&emsp;
&emsp;</div></div></div></div><a href=/posts/2023/mit_6.824_1_gfs/ class=a-block><div class=post-item-wrapper><div class="post-item post-item-no-divider"><div class=post-item-info-wrapper><div class=post-item-title>MIT 6.824 学习笔记(一) GFS</div><div class=post-item-summary><p>存储系统通常是一个分布式系统的基石，通常应用可以是无状态的，而所有状态便由存储系统来管理。</p><p>Google 文件系统（The Google File System, GFS）在 2003 年于一篇同名论文中被提出，发表在系统领域顶会 SOSP 上，是 Google 大数据三驾马车之一<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>。GFS 是一个成功的系统，在 00 年代早期，人们对于分布式文件系统已经有很好的理解了，但是尚未有一个可以扩展到上千个节点的系统被实现出来。很多 GFS 的设计被 HDFS 等后来的分布式文件系统上。</p><p>GFS 基于以下几个方面的观察：</p><ul><li>节点故障是常见的，因为其运行在大量普通机器（commodity components）上</li><li>存储的文件以大文件（数百 MB 到数 GB）为主，小文件应当被支持，但不应对其优化</li><li>对文件的大多数写入操作是追加 （append）而不是覆盖/随机写，大多数读取操作是顺序读 （1 MB 或更多）<ul><li>所以系统必须有良好的并发追加操作的语义</li><li>工作负载通常是批处理任务，所以高吞吐量比低延时重要</li></ul></li><li>同时设计应用和文件系统 API 有利于整个系统的灵活性</li></ul><h2 id=架构>架构</h2><p><img src=./image-20230901145431686.png alt=image-20230901145431686></p><p>GFS 采用 Master/Slave 架构，集群中存在一个 master 和多个 chunkservers，并且被多个 clients 访问。（由于单 master 的存在，GFS 存在单点故障的可能性，虽然 master 同样有备份，但恢复可能需要人工干预）一个文件将被分割成多个 chunk。chunk 的特性如下：</p><ul><li>固定大小，Google 的选择是 64 MB，这么大的 chunk 将有如下好处：<ul><li>减少 client 和 master 的通信，因为在获取到 chunk 的信息后，client 只需要和 chunkserver 交互进行读写</li><li>减少 metadata 的尺寸，以便所有 metadata 可以保存在内存中</li></ul></li><li>作为一个普通的 Linux 文件存储在 chunkserver 上</li><li>每个 chunk 由一个不可变的、唯一的 64 位 chunk handle 标记，其由 master 在 chunk 创建时指定<ul><li>chunkserver 根据 chunk handle 和偏移（byte range）来读写 chunk</li></ul></li><li>为了可靠性，每个 chunk 会被复制到多个 chunkservers 上 （通常为三个）</li></ul><p>master 管理了所有的元数据，用 Go 代码大概表示为：</p></div><div class=post-item-meta>2023-09-05
&emsp;
&emsp;</div></div></div></div><a href=/posts/2023/%E7%A5%9E%E7%A7%98%E7%9A%84%E8%87%AA%E5%8A%A8%E5%85%B3%E9%97%AD%E6%98%BE%E7%A4%BA%E5%99%A8%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98/ class=a-block><div class=post-item-wrapper><div class="post-item post-item-no-divider"><div class=post-item-info-wrapper><div class=post-item-title>神秘的自动关闭显示器失效问题</div><div class=post-item-summary><h2 id=问题>问题</h2><p>我的桌面环境为 KDE/X11，我在 KDE 的 Power Management 设置中设置了 <code>Screen Energy Saving: Switch off after 5 min</code>，这个选项时不时地出问题，表现为刚开机时能够正常工作，在闲置五分钟后关闭显示器，但在一段时间过后就不行了，这个一段时间可长可短。重启电脑又能重新工作，而锁屏后也能够正常工作。这个问题从我用 KDE 开始就一直困扰着我，时至今日。</p><h2 id=排查>排查</h2><p>KDE 的电源管理由 powerdevil 控制，其作为 <code>plasma-powerdevil.service</code> 用户服务运行，查询日志发现有一些神秘的 <code>org_kde_powerdevil[1310]: QObject::disconnect: Unexpected nullptr parameter</code> 报错，之后证实该报错与本问题无关。</p><p>查看该 <code>.service</code> 文件发现其使用 <code>Type=dbus</code> 的启动类型，并且获得了一个叫 <code>org.kde.Solid.PowerManagement</code> 的 bus name。用 QBBusViewer 可以看到 powerdevil 还提供了 <code>org.freedesktop.PowerManagement</code> 这一服务。</p><p>查阅 powerdevil 源码以 <code>Switch off after</code> 为关键词进行搜索可发现相关逻辑位于 <code>daemon/actions/bundled/dpms.cpp</code> 文件下，根据名字猜测 dpms 即 Display Power Management Signaling 的缩写。简单看了一下 dpms，这是一个古老的协议，在 1993 年发布，定义了四种模式，但 <a href=https://wiki.archlinux.org/title/Display_Power_Management_Signaling>archwiki 上</a>指出：</p><blockquote><p>Note that DPMS was developed for CRT monitors, and on LCD displays, there is normally no difference between the standby, suspend and off modes.</p></div><div class=post-item-meta>2023-09-04
&emsp;
&emsp;</div></div></div></div></a></div></div></div><div id=sideContainer class=side-container><a class="a-block nav-head active" href=https://blog.coherence.codes/><div class=nav-title>Coherence's Blog</div></a><div class=nav-link-list><a class="a-block nav-link-item false" href=/posts>存档
</a><a class="a-block nav-link-item false" href=/tags>标签
</a><a class="a-block nav-link-item false" href=/categories>分类
</a><a class="a-block nav-link-item false" href=/friends>友链
</a><a class="a-block nav-link-item false" href=/about>关于
</a><a class="a-block nav-link-item false" href=/index.xml>RSS Feed</a></div><div class=nav-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>移植自 <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Coherence. 本站遵循 CC BY-NC-SA 4.0 协议</div></div><div id=extraContainer class=extra-container><div class=toc-wrapper></div><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up
</i></a><a type=button class=pagination-action id=darkModeToggleButton><span class="material-icons pagination-action-icon" id=darkModeToggleIcon>dark_mode
</span></a><a class=pagination-action style=visibility:hidden><i class="material-icons pagination-action-icon">chevron_left</i></a><div class=pagination-indicator><span style=text-align:center>1<br><div style=display:inline-block;transform:rotate(-28deg)>-</div><br>5</span></div><a class=pagination-action href=/page/2/><i class="material-icons pagination-action-icon">chevron_right</i></a></div></div><div class=pagination><a class=pagination-action style=opacity:0><i class="material-icons pagination-action-icon">chevron_left</i></a><div class=pagination-indicator><span>1/5</span></div><a class=pagination-action href=/page/2/ style=opacity:1><i class="material-icons pagination-action-icon">chevron_right</i></a></div><div id=single-column-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>移植自 <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Coherence. 本站遵循 CC BY-NC-SA 4.0 协议</div></div><script src=/js/journal.js></script></body></html>